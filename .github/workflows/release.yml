name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 仅在推送 v 开头的 tag 时触发

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'

permissions:
  contents: write  # 允许创建 releases 和上传文件

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Get version from tag
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build Frontend
        run: |
          cd web
          npm ci
          npm run build
      
      - name: Build Windows Desktop
        shell: cmd
        run: |
          set CGO_ENABLED=1
          set GOOS=windows
          set GOARCH=amd64
          go build -ldflags="-X main.Version=${{ steps.version.outputs.VERSION }} -H windowsgui" -o bin/muxueTools.exe ./cmd/desktop
      
      - name: Create ZIP package
        shell: pwsh
        run: |
          mkdir -p dist
          Compress-Archive -Path bin/muxueTools.exe -DestinationPath dist/muxueTools-windows-amd64.zip
      
      - name: Install Inno Setup
        run: choco install innosetup -y
      
      - name: Download Chinese Language File
        shell: pwsh
        run: |
          $langPath = "C:\Program Files (x86)\Inno Setup 6\Languages"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/ChineseSimplified.isl" -OutFile "$langPath\ChineseSimplified.isl"
      
      - name: Build Windows Installer
        shell: pwsh
        run: |
          $env:VERSION = "${{ steps.version.outputs.VERSION }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DVersion=${{ steps.version.outputs.VERSION }} scripts\installer\windows\setup.iss
      
      - name: Generate latest.json
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TAG=${{ steps.version.outputs.TAG }}
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          mkdir -p dist/update
          cat > dist/update/latest.json << EOF
          {
            "version": "$VERSION",
            "release_date": "$DATE",
            "changelog": "## $TAG\n\n请查看 GitHub Release 获取完整更新日志。",
            "downloads": {
              "windows-amd64": "https://mxlnuma.space/muxueTools/releases/$TAG/muxueTools-windows-amd64.zip",
              "windows-amd64-installer": "https://github.com/muxueliunian/muxueTools/releases/download/$TAG/MuxueTools-Setup-$VERSION.exe",
              "linux-amd64": "https://github.com/muxueliunian/muxueTools/releases/download/$TAG/muxueTools-linux-amd64.tar.gz",
              "linux-amd64-deb": "https://github.com/muxueliunian/muxueTools/releases/download/$TAG/muxuetools_${VERSION}_amd64.deb"
            },
            "min_supported_version": "0.1.0",
            "is_critical": false,
            "announcement": ""
          }
          EOF
          cat dist/update/latest.json
      
      - name: Prepare releases directory
        shell: bash
        run: |
          TAG=${{ steps.version.outputs.TAG }}
          mkdir -p dist/releases/$TAG
          cp dist/*.zip dist/releases/$TAG/
      
      - name: Upload to Server via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME_TOOLS }}
          password: ${{ secrets.FTP_PASSWORD_TOOLS }}
          local-dir: ./dist/
          server-dir: /
          exclude: |
            **/*.exe
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            dist/*.zip
            dist/*.exe

  build-linux:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Install GTK/WebKit dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
      
      - name: Build Frontend
        run: |
          cd web
          npm ci
          npm run build
      
      - name: Build Linux Desktop
        run: |
          chmod +x scripts/build.sh
          VERSION=${{ steps.version.outputs.VERSION }} ./scripts/build.sh desktop
      
      - name: Build .deb Package
        run: |
          chmod +x scripts/installer/linux/build-deb.sh
          cd scripts/installer/linux
          ./build-deb.sh ${{ steps.version.outputs.VERSION }}
      
      - name: Create tarball
        run: |
          mkdir -p dist
          tar -czvf dist/muxueTools-linux-amd64.tar.gz -C bin muxuetools-desktop
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/*.tar.gz
            dist/*.deb

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true
      
      - name: List artifacts
        run: ls -la dist/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/MuxueTools-Setup-*.exe
            dist/muxueTools-windows-amd64.zip
            dist/muxueTools-linux-amd64.tar.gz
            dist/muxuetools_*.deb
          generate_release_notes: true
