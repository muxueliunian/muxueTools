# Gemini API å®¢æˆ·ç«¯å®¡æ ¸æŠ¥å‘Š

> **å®¡æ ¸å‘˜**: QA Engineer  
> **å®¡æ ¸æ—¥æœŸ**: 2026-01-15  
> **å®¡æ ¸èŒƒå›´**: `internal/gemini/client.go`, `client_test.go`
> **ä¿®å¤çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²äº 2026-01-15 02:18 ä¿®å¤

---

## å®¡æ ¸ç»“æœï¼šâœ… å·²é€šè¿‡

| æŒ‡æ ‡ | æ•°é‡ | çŠ¶æ€ |
|------|------|------|
| ä¸¥é‡é—®é¢˜ | 1 | âœ… å·²ä¿®å¤ |
| è­¦å‘Š | 2 | âœ… å·²ä¿®å¤ |
| å»ºè®®æ”¹è¿› | 4 | âœ… 1å·²å®ç° |
| æµ‹è¯•è¦†ç›–ç‡ | 74.7% â†’ 80%+ | âœ… |
| é™æ€åˆ†æ | `go vet` æ— è­¦å‘Š | âœ… |

---

## å„åŠŸèƒ½å®¡æ ¸

### é˜»å¡å¼è¯·æ±‚ (ChatCompletion)

**çŠ¶æ€**: âœ… é€šè¿‡

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| KeyPool è·å– | âœ… | æ­£ç¡®è·å– Key å¹¶åœ¨å‡½æ•°ç»“æŸæ—¶é‡Šæ”¾ |
| è¯·æ±‚è½¬æ¢ | âœ… | æ­£ç¡®è°ƒç”¨ `ConvertOpenAIRequest` |
| æ¨¡å‹æ˜ å°„ | âœ… | æ­£ç¡®è°ƒç”¨ `MapModelName` |
| HTTP è¯·æ±‚ | âœ… | URLã€Headersã€Body æ„å»ºæ­£ç¡® |
| å“åº”è§£æ | âœ… | æ­£ç¡®è§£æ Gemini å“åº” |
| æˆåŠŸæŠ¥å‘Š | âœ… | æˆåŠŸæ—¶æ­£ç¡®æŠ¥å‘Š Token ä½¿ç”¨é‡ |
| å¤±è´¥æŠ¥å‘Š | âœ… | å¤±è´¥æ—¶æ­£ç¡®è°ƒç”¨ `ReportFailure` |

**ä»£ç äº®ç‚¹**:
- ç¬¬ 99 è¡Œä½¿ç”¨ `defer c.pool.ReleaseKey(key)` ç¡®ä¿ Key é‡Šæ”¾
- Token ä½¿ç”¨é‡æ­£ç¡®ä» `UsageMetadata` æå–

---

### æµå¼è¯·æ±‚ (ChatCompletionStream)

**çŠ¶æ€**: âš ï¸ æœ‰é—®é¢˜

#### SSE è§£æ
**çŠ¶æ€**: âœ… é€šè¿‡
- ç¬¬ 242 è¡Œæ­£ç¡®æ£€æŸ¥ `data: ` å‰ç¼€
- ç¬¬ 247 è¡Œæ­£ç¡®æå– JSON æ•°æ®
- ç©ºè¡Œæ­£ç¡®è·³è¿‡

#### Chunk å¤„ç†
**çŠ¶æ€**: âœ… é€šè¿‡
- æ¯ä¸ª chunk æ­£ç¡®è½¬æ¢ä¸º OpenAI æ ¼å¼
- Token ä½¿ç”¨é‡ä»æœ€åä¸€ä¸ª chunk æ­£ç¡®ç´¯è®¡

#### ç»“æŸæ£€æµ‹
**çŠ¶æ€**: âœ… é€šè¿‡
- ç¬¬ 277 è¡Œæ­£ç¡®æ£€æµ‹ `finishReason`
- EOF æ­£ç¡®å¤„ç†ä¸ºæ­£å¸¸ç»“æŸ

#### Channel ç®¡ç†
**çŠ¶æ€**: âœ… é€šè¿‡
- ç¬¬ 206 è¡Œä½¿ç”¨ `defer close(eventChan)` ç¡®ä¿ channel å…³é—­
- goroutine åœ¨æ‰€æœ‰è·¯å¾„éƒ½èƒ½æ­£ç¡®é€€å‡º

#### Context å–æ¶ˆ
**çŠ¶æ€**: âœ… é€šè¿‡
- ç¬¬ 213-217 è¡Œæ­£ç¡®å“åº” `ctx.Done()`
- å–æ¶ˆæ—¶å‘é€é”™è¯¯äº‹ä»¶å¹¶æŠ¥å‘Šå¤±è´¥

#### èµ„æºç®¡ç†
**çŠ¶æ€**: âŒ **æœ‰é—®é¢˜**
- ç¬¬ 181-182 è¡Œå­˜åœ¨é—®é¢˜ï¼ˆè§ä¸‹æ–¹ä¸¥é‡é—®é¢˜ï¼‰

---

### KeyPool é›†æˆ

**çŠ¶æ€**: âš ï¸ æœ‰é—®é¢˜

| æ“ä½œ | é˜»å¡è¯·æ±‚ | æµå¼è¯·æ±‚ |
|------|----------|----------|
| GetKey | âœ… | âœ… |
| ReleaseKey | âœ… | âš ï¸ è§é—®é¢˜ |
| ReportSuccess | âœ… | âœ… |
| ReportFailure | âœ… | âš ï¸ è§é—®é¢˜ |

---

### é”™è¯¯å¤„ç†

**çŠ¶æ€**: âœ… é€šè¿‡

| é”™è¯¯åœºæ™¯ | æœŸæœ›è¡Œä¸º | å®é™…è¡Œä¸º |
|----------|----------|----------|
| KeyPool æ— å¯ç”¨ Key | `ErrNoAvailableKeys` | âœ… |
| API è¿”å› 429 | Rate Limit é”™è¯¯ + ç†”æ–­ | âœ… |
| API è¿”å› 401 | Authentication é”™è¯¯ | âœ… |
| API è¿”å› 400 | InvalidRequest é”™è¯¯ | âœ… |
| API è¿”å› 500 | Upstream é”™è¯¯ | âœ… |
| Context å–æ¶ˆ | è¶…æ—¶/å–æ¶ˆé”™è¯¯ | âœ… |
| å“åº”è§£æå¤±è´¥ | Upstream é”™è¯¯ | âœ… |

---

## é—®é¢˜è¯¦æƒ…

### âŒ ä¸¥é‡é—®é¢˜ #1: æµå¼è¯·æ±‚å¤±è´¥æ—¶é‡å¤é‡Šæ”¾ Key

**ä½ç½®**: `client.go` ç¬¬ 181-182 è¡Œ

```go
// 7. Send request
resp, err := c.httpClient.Do(httpReq)
if err != nil {
    c.pool.ReleaseKey(key)      // âŒ ç¬¬ä¸€æ¬¡é‡Šæ”¾
    c.pool.ReportFailure(key, err)  // ä½¿ç”¨å·²é‡Šæ”¾çš„ key
    return nil, c.wrapHTTPError(err)
}
```

**é—®é¢˜åˆ†æ**:
1. `ReleaseKey` åœ¨ `ReportFailure` ä¹‹å‰è°ƒç”¨
2. å¦‚æœ Pool å®ç°æœ‰ç‰¹æ®Šçš„é‡Šæ”¾é€»è¾‘ï¼ˆå¦‚ä»æ´»è·ƒåˆ—è¡¨ç§»é™¤ï¼‰ï¼Œ`ReportFailure` å¯èƒ½æ— æ³•æ­£ç¡®æ›´æ–°ç»Ÿè®¡
3. è™½ç„¶å½“å‰ `ReleaseKey` æ˜¯ no-opï¼Œä½†è¿™æ˜¯ä¸å®‰å…¨çš„è°ƒç”¨é¡ºåº

**å½±å“**: ä¸­åº¦ - å¯èƒ½å½±å“ç»Ÿè®¡å‡†ç¡®æ€§ï¼Œè¿åè¯­ä¹‰æ­£ç¡®æ€§

**å»ºè®®ä¿®å¤**:

```go
// 7. Send request
resp, err := c.httpClient.Do(httpReq)
if err != nil {
    c.pool.ReportFailure(key, err)  // å…ˆæŠ¥å‘Šå¤±è´¥
    c.pool.ReleaseKey(key)          // å†é‡Šæ”¾
    return nil, c.wrapHTTPError(err)
}
```

**åŒæ ·é—®é¢˜ä¹Ÿå­˜åœ¨äºç¬¬ 189-191 è¡Œ**:

```go
if resp.StatusCode != http.StatusOK {
    defer resp.Body.Close()
    c.pool.ReleaseKey(key)      // âŒ åº”è¯¥åœ¨ ReportFailure ä¹‹å
    appErr := c.parseErrorResponse(resp)
    c.pool.ReportFailure(key, appErr)
    return nil, appErr
}
```

---

### âš ï¸ è­¦å‘Š #1: streamResponse ä¸­ Context æ£€æŸ¥æ—¶æœº

**ä½ç½®**: `client.go` ç¬¬ 212-219 è¡Œ

```go
for {
    select {
    case <-ctx.Done():
        eventChan <- StreamEvent{Err: ctx.Err()}
        c.pool.ReportFailure(key, ctx.Err())
        return
    default:
    }

    line, err := reader.ReadBytes('\n')  // âš ï¸ é˜»å¡è°ƒç”¨
```

**é—®é¢˜**: 
- `reader.ReadBytes('\n')` æ˜¯é˜»å¡è°ƒç”¨
- å¦‚æœç½‘ç»œå¡ä½ï¼Œå³ä½¿ context è¢«å–æ¶ˆï¼Œgoroutine ä¹Ÿä¼šç»§ç»­é˜»å¡
- `select` åªåœ¨å¾ªç¯å¼€å§‹æ—¶æ£€æŸ¥ context

**å½±å“**: ä½ - æœåŠ¡ç«¯æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿï¼Œä½†æç«¯æƒ…å†µå¯èƒ½é€ æˆ goroutine å»¶è¿Ÿé€€å‡º

**å»ºè®®**: å¯æ¥å—å½“å‰å®ç°ï¼Œæˆ–è€ƒè™‘ä½¿ç”¨å¸¦è¶…æ—¶çš„è¯»å–

---

### âš ï¸ è­¦å‘Š #2: streamResponse å‘é€äº‹ä»¶å¯èƒ½é˜»å¡

**ä½ç½®**: `client.go` ç¬¬ 274 è¡Œ

```go
// Send chunk to channel
eventChan <- StreamEvent{Chunk: openAIChunk}  // âš ï¸ æ— ç¼“å†² channel
```

**é—®é¢˜**:
- `eventChan` æ˜¯æ— ç¼“å†² channel
- å¦‚æœæ¶ˆè´¹è€…å¤„ç†ç¼“æ…¢ï¼Œå‘é€ä¼šé˜»å¡
- é˜»å¡æœŸé—´ context å–æ¶ˆæ— æ³•ç«‹å³å“åº”

**å½±å“**: ä½ - æ­£å¸¸ä½¿ç”¨ä¸ä¼šè§¦å‘ï¼Œæ¶ˆè´¹è€…é€šå¸¸åŠæ—¶æ¶ˆè´¹

**å»ºè®®**: å¯è€ƒè™‘ä½¿ç”¨å¸¦ç¼“å†²çš„ channel æˆ– `select` å‘é€

```go
select {
case eventChan <- StreamEvent{Chunk: openAIChunk}:
case <-ctx.Done():
    c.pool.ReportFailure(key, ctx.Err())
    return
}
```

---

### ğŸ’¡ æ”¹è¿›å»ºè®®

#### å»ºè®® #1: å¢åŠ  nil è¯·æ±‚æ£€æŸ¥

```go
func (c *Client) ChatCompletion(ctx context.Context, req *types.ChatCompletionRequest) (*types.ChatCompletionResponse, error) {
    if req == nil {
        return nil, types.NewInvalidRequestError("Request cannot be nil")
    }
    // ...
}
```

#### å»ºè®® #2: æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ° 85%+

å½“å‰è¦†ç›–ç‡ 74.7%ï¼Œå»ºè®®å¢åŠ ä»¥ä¸‹æµ‹è¯•ï¼š
- æµä¸­é€”æ–­å¼€æµ‹è¯•
- ç½‘ç»œè¶…æ—¶æµ‹è¯•
- è§£æå¤±è´¥æ¢å¤æµ‹è¯•
- `wrapHTTPError` ä¸åŒåœºæ™¯æµ‹è¯•

#### å»ºè®® #3: è€ƒè™‘é‡è¯•æœºåˆ¶

å½“å‰å®ç°åœ¨å¤±è´¥æ—¶ç›´æ¥è¿”å›é”™è¯¯ï¼Œå¯è€ƒè™‘ï¼š
- å¯é…ç½®çš„é‡è¯•æ¬¡æ•°
- æŒ‡æ•°é€€é¿ç­–ç•¥
- ä»…é‡è¯•å¯æ¢å¤é”™è¯¯ï¼ˆå¦‚ç½‘ç»œæŠ–åŠ¨ï¼‰

#### å»ºè®® #4: æå– KeyPool é‡Šæ”¾åˆ°ç»Ÿä¸€ä½ç½®

é˜»å¡è¯·æ±‚ä½¿ç”¨ `defer ReleaseKey`ï¼Œæµå¼è¯·æ±‚åœ¨ goroutine ä¸­ä½¿ç”¨ `defer`ã€‚
è€ƒè™‘ä¸ºæµå¼è¯·æ±‚ä¹Ÿä½¿ç”¨ç±»ä¼¼æ¨¡å¼ï¼Œå‡å°‘å¤šå¤„æ‰‹åŠ¨é‡Šæ”¾å¸¦æ¥çš„é£é™©ã€‚

---

## æµ‹è¯•å®Œæ•´æ€§è¯„ä¼°

### å·²è¦†ç›–åœºæ™¯

| æµ‹è¯•ç±»å‹ | æµ‹è¯•æ•°é‡ | è¦†ç›–æƒ…å†µ |
|----------|----------|----------|
| é˜»å¡è¯·æ±‚æˆåŠŸ | 2 | âœ… SimpleText, WithGenerationConfig |
| æµå¼è¯·æ±‚æˆåŠŸ | 1 | âœ… å¤š chunk + finishReason |
| KeyPool æ—  Key | 1 | âœ… |
| 429 é”™è¯¯ | 1 | âœ… |
| 401 é”™è¯¯ | 1 | âœ… |
| 500 é”™è¯¯ | 1 | âœ… |
| Context å–æ¶ˆ | 2 | âœ… é˜»å¡ + æµå¼ |
| æ¨¡å‹æ˜ å°„ | 1 | âœ… |

### ç¼ºå¤±åœºæ™¯

| åœºæ™¯ | é‡è¦æ€§ |
|------|--------|
| æµä¸­é€”æ–­å¼€ | é«˜ |
| ç½‘ç»œè¿æ¥å¤±è´¥ | ä¸­ |
| å“åº” JSON è§£æé”™è¯¯ | ä¸­ |
| å¹¶å‘å¤šè¯·æ±‚ | ä¸­ |
| ç©ºå“åº”å€™é€‰ | ä½ |

---

## ä»£ç è´¨é‡æ€»ç»“

| æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|--------|------|
| Godoc æ³¨é‡Šå®Œæ•´ | âœ… |
| é”™è¯¯å¤„ç†è§„èŒƒ | âœ… ä½¿ç”¨é¢„å®šä¹‰é”™è¯¯ |
| Context ä¼ æ’­ | âœ… æ­£ç¡®ä¼ é€’ |
| èµ„æºç®¡ç† | âš ï¸ æœ‰é—®é¢˜ |
| å¹¶å‘å®‰å…¨ | âœ… æ— å…±äº«å¯å˜çŠ¶æ€ |
| æ¥å£è®¾è®¡ | âœ… `KeyPoolInterface` ä¾¿äºæµ‹è¯• |

---

## æ€»ç»“

### ç»Ÿè®¡

| çº§åˆ« | æ•°é‡ |
|------|------|
| âŒ ä¸¥é‡é—®é¢˜ | 1 |
| âš ï¸ è­¦å‘Š | 2 |
| ğŸ’¡ å»ºè®®æ”¹è¿› | 4 |

### å¿…é¡»ä¿®å¤é¡¹

1. **æµå¼è¯·æ±‚ä¸­ ReleaseKey å’Œ ReportFailure è°ƒç”¨é¡ºåºé”™è¯¯**
   - ä½ç½®: ç¬¬ 181-182 è¡Œã€ç¬¬ 189-191 è¡Œ
   - åº”è¯¥å…ˆ `ReportFailure` å† `ReleaseKey`

### ç»“è®º

**é˜»å¡çŠ¶æ€**: â›” **éœ€å…ˆä¿®å¤ä¸¥é‡é—®é¢˜åå†ç»§ç»­å¼€å‘**

æ•´ä½“è®¾è®¡åˆç†ï¼Œé˜»å¡è¯·æ±‚è·¯å¾„æ­£ç¡®ï¼Œä½†æµå¼è¯·æ±‚çš„å¤±è´¥å¤„ç†è·¯å¾„æœ‰é—®é¢˜ã€‚
å»ºè®®ä¿®å¤åé‡æ–°è¿è¡Œæµ‹è¯•å¹¶éªŒè¯ç†”æ–­é€»è¾‘ã€‚

---

## é™„å½•ï¼šä¿®å¤ä»£ç 

### ä¿®å¤ç¬¬ 181-183 è¡Œ

```go
// 7. Send request
resp, err := c.httpClient.Do(httpReq)
if err != nil {
    c.pool.ReportFailure(key, err)  // å…ˆæŠ¥å‘Šå¤±è´¥
    c.pool.ReleaseKey(key)          // å†é‡Šæ”¾
    return nil, c.wrapHTTPError(err)
}
```

### ä¿®å¤ç¬¬ 186-193 è¡Œ

```go
// 8. Check for error status codes
if resp.StatusCode != http.StatusOK {
    defer resp.Body.Close()
    appErr := c.parseErrorResponse(resp)
    c.pool.ReportFailure(key, appErr)  // å…ˆæŠ¥å‘Šå¤±è´¥
    c.pool.ReleaseKey(key)              // å†é‡Šæ”¾
    return nil, appErr
}
```

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-01-15 02:14*
