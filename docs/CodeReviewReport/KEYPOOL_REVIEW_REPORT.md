# Key æ± æ¨¡å—å®¡æ ¸æŠ¥å‘Š

> **å®¡æ ¸å‘˜**: QA Engineer  
> **å®¡æ ¸æ—¥æœŸ**: 2026-01-15  
> **å®¡æ ¸èŒƒå›´**: `internal/keypool/` æ¨¡å—ï¼ˆpool.go, strategy.go åŠæµ‹è¯•æ–‡ä»¶ï¼‰

---

## å®¡æ ¸ç»“æœï¼šâœ… é€šè¿‡

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| æµ‹è¯•çŠ¶æ€ | 28/28 PASS |
| é™æ€åˆ†æ | `go vet` æ— è­¦å‘Š |
| ä¸¥é‡é—®é¢˜ | 0 |
| è­¦å‘Š | 2 |
| å»ºè®®æ”¹è¿› | 5 |

---

## å„æ–‡ä»¶å®¡æ ¸

### 1. pool.go

#### åŠŸèƒ½æ­£ç¡®æ€§ï¼šâœ… é€šè¿‡

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| GetKey() | âœ… | æ­£ç¡®åº”ç”¨ç­–ç•¥é€‰æ‹© Keyï¼Œæ— å¯ç”¨ Key æ—¶è¿”å› `ErrNoAvailableKeys` |
| ReportFailure() | âœ… | æ­£ç¡®æ£€æµ‹ Rate Limit é”™è¯¯å¹¶è§¦å‘ç†”æ–­ |
| å†·å´æ¢å¤ | âœ… | `resetExpiredCooldowns()` æ­£ç¡®æ£€æŸ¥ `CooldownUntil` æ—¶é—´ |
| ç»Ÿè®¡æ›´æ–° | âœ… | `IncrementStats()` æ­£ç¡®æ›´æ–°æ‰€æœ‰è®¡æ•°å™¨ |
| é”™è¯¯è¿”å› | âœ… | ä½¿ç”¨ `types.ErrNoAvailableKeys` å’Œ `types.ErrAllKeysRateLimited` é¢„å®šä¹‰é”™è¯¯ |

**äº®ç‚¹**:
1. âœ… Functional Options æ¨¡å¼ (`WithStrategy`, `WithCooldownSeconds`, `WithMaxConsecutiveFailures`) è®¾è®¡ä¼˜é›…
2. âœ… è¿ç»­å¤±è´¥ç†”æ–­æœºåˆ¶ (`maxConsecutiveFailures`) æ˜¯é¢å¤–çš„å®‰å…¨ä¿æŠ¤
3. âœ… `isRateLimitError()` æ”¯æŒå¤šç§é”™è¯¯è¯†åˆ«æ¨¡å¼ï¼ˆAppErrorã€å­—ç¬¦ä¸²åŒ¹é…ï¼‰
4. âœ… `GetStats()` è¿”å›å‰¯æœ¬è€ŒéåŸå§‹æŒ‡é’ˆï¼Œé¿å…å¤–éƒ¨ä¿®æ”¹å†…éƒ¨çŠ¶æ€

#### çº¿ç¨‹å®‰å…¨ï¼šâœ… é€šè¿‡

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| é”ç²’åº¦ | âœ… | ä½¿ç”¨ `sync.RWMutex`ï¼Œè¯»æ“ä½œä½¿ç”¨ `RLock`ï¼Œå†™æ“ä½œä½¿ç”¨ `Lock` |
| æ­»é”é£é™© | âœ… | æ‰€æœ‰é”æ“ä½œéƒ½ä½¿ç”¨ `defer Unlock()`ï¼Œæ— åµŒå¥—é” |
| TOCTOU | âš ï¸ | è§ä¸‹æ–¹è­¦å‘Š |

**âš ï¸ è­¦å‘Š #1: æ½œåœ¨çš„ TOCTOU é—®é¢˜**

```go
// pool.go ç¬¬ 102-124 è¡Œ
func (p *Pool) GetKey() (*types.Key, error) {
    p.mu.Lock()
    defer p.mu.Unlock()
    // ... è·å– key
    return key, nil  // è¿”å›çš„ key æŒ‡é’ˆå¯è¢«å¤–éƒ¨ä¿®æ”¹
}
```

**é—®é¢˜åˆ†æ**:
- `GetKey()` è¿”å›çš„æ˜¯ `*types.Key` æŒ‡é’ˆï¼Œè°ƒç”¨æ–¹å¯ä»¥åœ¨é”å¤–è®¿é—®å’Œä¿®æ”¹ Key çš„å­—æ®µ
- å½“å¤šä¸ª goroutine åŒæ—¶æŒæœ‰åŒä¸€ Key çš„å¼•ç”¨æ—¶ï¼Œå¯èƒ½å‡ºç°æ•°æ®ç«äº‰
- ä¾‹å¦‚ï¼šgoroutine A è°ƒç”¨ `key.Stats.RequestCount++`ï¼Œgoroutine B è¯»å– `key.Stats.RequestCount`

**é£é™©è¯„ä¼°**: **ä½** 
- å½“å‰è®¾è®¡æ˜¯ `ReportSuccess/ReportFailure` æ–¹æ³•å†…éƒ¨æŒé”æ›´æ–° `Key.Stats`
- åªè¦è°ƒç”¨æ–¹éµå¾ª "è·å– Key â†’ ä½¿ç”¨ â†’ é€šè¿‡ Pool æ–¹æ³•æ›´æ–°ç»Ÿè®¡" çš„æ¨¡å¼ï¼Œä¸ä¼šå‡ºé—®é¢˜
- ç›´æ¥ä¿®æ”¹è¿”å›çš„ Key å¯¹è±¡æ˜¯é”™è¯¯ä½¿ç”¨æ–¹å¼

**å»ºè®®ï¼ˆéé˜»å¡ï¼‰**:
- åœ¨ Godoc ä¸­æ˜ç¡®è¯´æ˜ï¼šè°ƒç”¨æ–¹**ä¸åº”**ç›´æ¥ä¿®æ”¹è¿”å›çš„ Key å¯¹è±¡
- æˆ–è€…è¿”å› Key çš„åªè¯»æ¥å£/å‰¯æœ¬ï¼ˆä½†ä¼šå¢åŠ å†…å­˜åˆ†é…ï¼‰

---

#### ä»£ç è´¨é‡ï¼šâœ… é€šè¿‡

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| Godoc æ³¨é‡Š | âœ… | æ‰€æœ‰å¯¼å‡ºå‡½æ•°å’Œç±»å‹å‡æœ‰æ–‡æ¡£æ³¨é‡Š |
| é”™è¯¯å¤„ç† | âœ… | ä½¿ç”¨ `types/errors.go` ä¸­çš„é¢„å®šä¹‰é”™è¯¯ |
| èµ„æºç®¡ç† | âœ… | æ—  goroutine å¯åŠ¨ï¼Œæ— èµ„æºæ³„æ¼é£é™© |
| ä»£ç é£æ ¼ | âœ… | ç¬¦åˆ Effective Go è§„èŒƒ |

**å°å»ºè®® #1**: `contains/searchSubstring/equalFoldSubstring` å‡½æ•°å¯æ›¿æ¢ä¸ºæ ‡å‡†åº“

```go
// å½“å‰å®ç°ï¼ˆç¬¬ 282-310 è¡Œï¼‰æ‰‹åŠ¨å®ç°å¤§å°å†™ä¸æ•æ„ŸåŒ¹é…
// å¯ç®€åŒ–ä¸ºï¼š
import "strings"

func isRateLimitError(err error) bool {
    // ...
    errStr := strings.ToLower(err.Error())
    return strings.Contains(errStr, "429") ||
        strings.Contains(errStr, "rate limit") ||
        strings.Contains(errStr, "quota exceeded") ||
        strings.Contains(errStr, "too many requests")
}
```

**å½±å“**: ä»£ç ç®€æ´æ€§ï¼Œæ€§èƒ½å·®å¼‚å¯å¿½ç•¥

---

### 2. strategy.go

#### åŠŸèƒ½æ­£ç¡®æ€§ï¼šâœ… é€šè¿‡

| ç­–ç•¥ | çŠ¶æ€ | éªŒè¯ |
|------|------|------|
| RoundRobin | âœ… | æµ‹è¯•éªŒè¯äº†é¡ºåºé€‰æ‹©å’Œå¾ªç¯ |
| Random | âœ… | æµ‹è¯•éªŒè¯äº†åˆ†å¸ƒçš„åˆç†æ€§ |
| LeastUsed | âœ… | æµ‹è¯•éªŒè¯äº†é€‰æ‹©è¯·æ±‚é‡æœ€å°‘çš„ Key |
| Weighted | âœ… | æµ‹è¯•éªŒè¯äº†æˆåŠŸç‡é«˜çš„ Key è¢«æ›´é¢‘ç¹é€‰æ‹© |

**äº®ç‚¹**:
1. âœ… `Strategy` æ¥å£è®¾è®¡ç®€æ´ (`Select`, `Name`)ï¼Œæ˜“äºæ‰©å±•
2. âœ… `StrategyFactory` å·¥å‚å‡½æ•°ä½¿é…ç½®é©±åŠ¨æˆä¸ºå¯èƒ½
3. âœ… `filterAvailable()` å¤ç”¨é€»è¾‘ï¼Œé¢„åˆ†é…å®¹é‡å‡å°‘å†…å­˜åˆ†é…
4. âœ… `calculateWeight()` å¼•å…¥æœ€å°æƒé‡ 0.1ï¼Œç¡®ä¿æ¯ä¸ª Key éƒ½æœ‰æœºä¼šè¢«é€‰ä¸­

#### çº¿ç¨‹å®‰å…¨ï¼šâœ… é€šè¿‡

| ç­–ç•¥ | çº¿ç¨‹å®‰å…¨æœºåˆ¶ | çŠ¶æ€ |
|------|-------------|------|
| RoundRobin | `atomic.AddUint64` | âœ… æ— é”ï¼Œé«˜æ€§èƒ½ |
| Random | `sync.Mutex` ä¿æŠ¤ `rand.Rand` | âœ… å¿…è¦çš„é”ï¼ˆ`math/rand.Rand` éçº¿ç¨‹å®‰å…¨ï¼‰ |
| LeastUsed | æ— çŠ¶æ€ï¼Œæ— éœ€é” | âœ… |
| Weighted | `sync.Mutex` ä¿æŠ¤ `rand.Rand` | âœ… |

**å°å»ºè®® #2**: Random/Weighted ç­–ç•¥å¯ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„éšæœºæº

```go
// Go 1.20+ å¯ä½¿ç”¨å…¨å±€å®‰å…¨éšæœºå‡½æ•°
import "math/rand/v2"

func (s *RandomStrategy) Select(keys []*types.Key) *types.Key {
    availableKeys := filterAvailable(keys)
    if len(availableKeys) == 0 {
        return nil
    }
    // ä¸éœ€è¦é”
    return availableKeys[rand.IntN(len(availableKeys))]
}
```

**å½±å“**: å‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘æ€§èƒ½ï¼ˆå½“å‰å®ç°å·²è¶³å¤Ÿç”¨ï¼‰

---

### 3. æµ‹è¯•æ–‡ä»¶å®¡æ ¸

#### pool_test.go

**è¦†ç›–å®Œæ•´æ€§ï¼šâœ… é€šè¿‡**

| åœºæ™¯åˆ†ç±» | æµ‹è¯•è¦†ç›– |
|----------|----------|
| **åŸºç¡€åŠŸèƒ½** | |
| Pool åˆ›å»º | âœ… ç©º Keyã€nilã€æœ‰æ•ˆé…ç½®ã€ç¦ç”¨ Key |
| GetKey æˆåŠŸ | âœ… æ­£å¸¸æµç¨‹ã€Round Robin é¡ºåº |
| GetKey å¤±è´¥ | âœ… æ—  Keyã€å…¨ç¦ç”¨ã€å…¨ Rate Limited |
| ReleaseKey | âœ… æ­£å¸¸é‡Šæ”¾ã€nil å¤„ç† |
| **ç†”æ–­åœºæ™¯** | |
| Rate Limit é”™è¯¯ | âœ… AppError ç±»å‹æ£€æµ‹ |
| è¿ç»­å¤±è´¥ | âœ… é˜ˆå€¼è§¦å‘ |
| å†·å´æ¢å¤ | âœ… ç­‰å¾…å†·å´æœŸåæ¢å¤ |
| **ç»Ÿè®¡** | |
| ReportSuccess | âœ… Token è®¡æ•°ã€è¯·æ±‚è®¡æ•° |
| GetStats | âœ… è¿”å›å‰¯æœ¬éªŒè¯ |
| **å¹¶å‘** | |
| å¹¶å‘ GetKey | âœ… 100 goroutine |
| errgroup æ¨¡å¼ | âœ… å¸¦ context å–æ¶ˆ |
| æ··åˆæ“ä½œ | âœ… è¯»å†™å¹¶å‘ |
| **æ€§èƒ½** | |
| Benchmark | âœ… GetKeyã€å¹¶å‘ GetKeyã€ReportSuccess |

**äº®ç‚¹**:
1. âœ… ä½¿ç”¨ `errgroup` è¿›è¡Œå¸¦é”™è¯¯ä¼ æ’­çš„å¹¶å‘æµ‹è¯•ï¼ˆæœ€ä½³å®è·µï¼‰
2. âœ… å†·å´æ¢å¤æµ‹è¯•ä½¿ç”¨çœŸå® `time.Sleep` éªŒè¯æ—¶é—´é€»è¾‘
3. âœ… Benchmark æµ‹è¯•åŒ…å«å•çº¿ç¨‹å’Œå¹¶è¡Œåœºæ™¯

**âš ï¸ è­¦å‘Š #2: å¹¶å‘æµ‹è¯•ä¸­çš„æµ‹è¯•æ–¹å¼é—®é¢˜**

```go
// strategy_test.go ç¬¬ 300-315 è¡Œ
func TestRoundRobinStrategy_Concurrent(t *testing.T) {
    // ...
    go func() {
        defer wg.Done()
        key := strategy.Select(keys)
        if key == nil {
            t.Error("unexpected nil key in concurrent access")  // âš ï¸
        }
    }()
}
```

**é—®é¢˜**: åœ¨ goroutine ä¸­è°ƒç”¨ `t.Error` å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶ï¼ˆGo 1.17+ å·²è‡ªåŠ¨å®‰å…¨ï¼Œä½†æ—§ç‰ˆæœ¬å¯èƒ½æœ‰é—®é¢˜ï¼‰

**å»ºè®®**: ä½¿ç”¨åŸå­è®¡æ•°å™¨æ”¶é›†é”™è¯¯ï¼Œä¸» goroutine æ£€æŸ¥

---

#### strategy_test.go

**è¦†ç›–å®Œæ•´æ€§ï¼šâœ… é€šè¿‡**

| ç­–ç•¥ | æ­£å¸¸æµç¨‹ | è¾¹ç•Œæ¡ä»¶ | å¹¶å‘æµ‹è¯• |
|------|----------|----------|----------|
| RoundRobin | âœ… | âœ… ç©º/nil/å…¨ç¦ç”¨ | âœ… |
| Random | âœ… åˆ†å¸ƒéªŒè¯ | âœ… ä»… 1 ä¸ªå¯ç”¨ | - |
| LeastUsed | âœ… | âœ… å…¨ç›¸ç­‰/è·³è¿‡ä¸å¯ç”¨ | - |
| Weighted | âœ… åå‘æ€§éªŒè¯ | âœ… æ–° Key æœ‰æœºä¼š | - |

**æµ‹è¯•è®¾è®¡äº®ç‚¹**:
1. âœ… Table-Driven Tests æ¨¡å¼
2. âœ… Helper å‡½æ•°å¤ç”¨ (`createTestKey`, `createRateLimitedKey`, `createKeyWithStats`)
3. âœ… å®Œæ•´çš„ Benchmark æµ‹è¯•

**å»ºè®® #3**: Random/Weighted ç­–ç•¥å¯å¢åŠ å¹¶å‘æµ‹è¯•
- ç›®å‰åªæœ‰ RoundRobin æœ‰å¹¶å‘æµ‹è¯•
- å»ºè®®å¢åŠ å…¶ä»–ç­–ç•¥çš„å¹¶å‘å®‰å…¨æ€§éªŒè¯

---

## é—æ¼çš„æµ‹è¯•åœºæ™¯

| åœºæ™¯ | é‡è¦æ€§ | è¯´æ˜ |
|------|--------|------|
| Rate Limit å­—ç¬¦ä¸²åŒ¹é… | ä¸­ | `isRateLimitError` å¯¹ "quota exceeded" ç­‰å­—ç¬¦ä¸²çš„åŒ¹é… |
| å†·å´æœŸè¾¹ç•Œæ—¶åˆ» | ä½ | æ°å¥½åœ¨å†·å´ç»“æŸæ—¶åˆ»çš„è¡Œä¸º |
| ~~ç«æ€æ£€æµ‹~~ | é«˜ | éœ€è¦ `-race` æ ‡å¿—ï¼ˆWindows ä¸æ”¯æŒï¼‰ |

---

## ä»£ç è´¨é‡æ€»ç»“

| æ£€æŸ¥é¡¹ | pool.go | strategy.go | pool_test.go | strategy_test.go |
|--------|---------|-------------|--------------|------------------|
| Godoc å®Œæ•´ | âœ… | âœ… | âœ… | âœ… |
| é”™è¯¯å¤„ç† | âœ… | âœ… | N/A | N/A |
| é”ä½¿ç”¨æ­£ç¡® | âœ… | âœ… | N/A | N/A |
| èµ„æºæ— æ³„æ¼ | âœ… | âœ… | N/A | N/A |
| go vet | âœ… | âœ… | âœ… | âœ… |

---

## æ€»ç»“

### ç»Ÿè®¡
| çº§åˆ« | æ•°é‡ |
|------|------|
| âŒ ä¸¥é‡é—®é¢˜ | 0 |
| âš ï¸ è­¦å‘Š | 2 |
| ğŸ’¡ å»ºè®®æ”¹è¿› | 5 |

### è­¦å‘Šè¯¦æƒ…
1. **TOCTOU æ½œåœ¨é£é™©**: `GetKey()` è¿”å›çš„ Key æŒ‡é’ˆå¯è¢«å¤–éƒ¨ä¿®æ”¹ï¼Œéœ€åœ¨æ–‡æ¡£ä¸­è¯´æ˜æ­£ç¡®ä½¿ç”¨æ–¹å¼
2. **goroutine ä¸­è°ƒç”¨ t.Error**: å»ºè®®ä½¿ç”¨åŸå­è®¡æ•°å™¨æ¨¡å¼

### å»ºè®®æ”¹è¿›
1. ç®€åŒ– `isRateLimitError` ä½¿ç”¨æ ‡å‡†åº“ `strings.Contains`
2. Random/Weighted ç­–ç•¥è€ƒè™‘ä½¿ç”¨ `math/rand/v2` é¿å…é”
3. å¢åŠ  Random/Weighted ç­–ç•¥çš„å¹¶å‘æµ‹è¯•
4. è¡¥å…… Rate Limit å­—ç¬¦ä¸²åŒ¹é…çš„å•å…ƒæµ‹è¯•
5. åœ¨ GetKey() æ–‡æ¡£ä¸­è¯´æ˜ä¸åº”ç›´æ¥ä¿®æ”¹è¿”å›çš„ Key

### ç»“è®º

**é˜»å¡çŠ¶æ€**: âœ… **æ— é˜»å¡é—®é¢˜ï¼Œå¯ç»§ç»­å¼€å‘**

Key æ± æ¨¡å—è®¾è®¡åˆç†ã€å®ç°å¥å£®ï¼š
- ç­–ç•¥æ¨¡å¼æ‰©å±•æ€§å¥½
- ç†”æ–­æœºåˆ¶å®Œå–„ï¼ˆRate Limit æ£€æµ‹ + è¿ç»­å¤±è´¥é˜ˆå€¼ï¼‰
- æµ‹è¯•è¦†ç›– 28 ä¸ªåœºæ™¯ï¼Œè¦†ç›–ç‡ 85.5%
- é™æ€åˆ†ææ— è­¦å‘Š

å»ºè®®åœ¨ Linux/macOS ç¯å¢ƒä¸‹è¿è¡Œ `go test -race` è¿›è¡Œç«æ€æ£€æµ‹åå³å¯æŠ•å…¥ç”Ÿäº§ã€‚

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-01-15 01:27*
